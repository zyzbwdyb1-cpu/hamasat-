import os, time
from dotenv import load_dotenv
import telebot
from telebot.types import InlineKeyboardMarkup, InlineKeyboardButton, CallbackQuery

load_dotenv()
TOKEN = os.getenv("BOT_TOKEN", "8318407816:AAE8KALWKnJXUwenjZCgI5LN29lL9MAIArg")
bot = telebot.TeleBot(TOKEN, parse_mode="HTML")

# Ø¬Ù„Ø³Ø§Øª ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù‡Ù…Ø³Ø§Øª: { user_id: {"target": target_id, "chat": chat_id, "reply_msg": msg_id} }
sessions = {}
# Ù‡Ù…Ø³Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©: { whisper_id: {"target":..., "text":...} }
whispers = {}

def make_whisper_id():
    return str(int(time.time()*1000))

# 1) Ù„Ù…Ø§ ØªÙƒØªØ¨ "Ø§Ù‡Ù…Ø³" Ø±Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø´Ø®Øµ
@bot.message_handler(func=lambda m: m.reply_to_message and m.text.strip()=="Ø§Ù‡Ù…Ø³")
def ask_for_whisper(message):
    sender = message.from_user
    target = message.reply_to_message.from_user
    chat_id = message.chat.id

    sessions[sender.id] = {"target": target.id, "chat": chat_id}

    kb = InlineKeyboardMarkup()
    kb.add(InlineKeyboardButton("ğŸ“ Ø§Ù‡Ù…Ø³ Ù‡Ù†Ø§", url=f"https://t.me/{bot.get_me().username}?start=whisper_{sender.id}"))

    bot.reply_to(message, f"ğŸ“© Ø§Ø¶ØºØ· Ù„Ù„ÙƒØªØ§Ø¨Ø© Ø¥Ù„Ù‰ <b>{target.first_name}</b>:", reply_markup=kb)

# 2) Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ /start ÙÙŠ Ø§Ù„Ø®Ø§Øµ Ù…Ø¹ session id
@bot.message_handler(commands=["start"])
def on_start(message):
    args = message.text.split()
    if len(args)>1 and args[1].startswith("whisper_"):
        sender_id = int(args[1].split("_")[1])
        if message.from_user.id != sender_id:
            bot.reply_to(message, "âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø¹ÙˆØ© Ù„ÙŠØ³Øª Ù„Ùƒ.")
            return

        if sender_id in sessions:
            target_id = sessions[sender_id]["target"]
            bot.send_message(sender_id, f"âœï¸ Ø§ÙƒØªØ¨ Ø§Ù„Ø¢Ù† Ù‡Ù…Ø³ØªÙƒ Ø¥Ù„Ù‰ <b>{target_id}</b>:")
        else:
            bot.send_message(sender_id, "âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø© Ù‡Ù…Ø³Ø© Ù…ÙØªÙˆØ­Ø©.")

# 3) Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù‡Ù…Ø³Ø© ÙÙŠ Ø§Ù„Ø®Ø§Øµ
@bot.message_handler(func=lambda m: m.from_user.id in sessions and m.chat.type=="private")
def receive_whisper(message):
    sender_id = message.from_user.id
    sess = sessions.pop(sender_id)

    whisper_id = make_whisper_id()
    whispers[whisper_id] = {"target": sess["target"], "text": message.text}

    try: bot.delete_message(message.chat.id, message.message_id)  # Ø­Ø°Ù Ø§Ù„Ø³Ø±ÙŠØ©
    except: pass

    kb = InlineKeyboardMarkup()
    kb.add(InlineKeyboardButton("ğŸ“© Ø§ÙØªØ­ Ø§Ù„Ù‡Ù…Ø³Ø©", callback_data=f"open:{whisper_id}"))

    bot.send_message(sess["chat"], f"ğŸ”’ Ù‡Ù…Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©!", reply_markup=kb)

# 4) ÙØªØ­ Ø§Ù„Ù‡Ù…Ø³Ø© Ù…Ù† Ø§Ù„Ø¬Ø±ÙˆØ¨
@bot.callback_query_handler(func=lambda c: c.data.startswith("open:"))
def open_whisper(call: CallbackQuery):
    wid = call.data.split(":",1)[1]
    if wid not in whispers:
        bot.answer_callback_query(call.id, "âŒ Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù‡Ù…Ø³Ø©.", show_alert=True)
        return

    w = whispers[wid]
    if call.from_user.id != w["target"]:
        bot.answer_callback_query(call.id, "ğŸš« Ù‡Ø°Ù‡ Ø§Ù„Ù‡Ù…Ø³Ø© Ù„ÙŠØ³Øª Ù„Ùƒ.", show_alert=True)
        return

    # âœ… Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Øµ ÙÙ‚Ø· Ù„Ù„Ù…Ù‚ØµÙˆØ¯ (Ø±Ø³Ø§Ù„Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù‡ ÙˆØ­Ø¯Ù‡)
    bot.answer_callback_query(call.id, f"ğŸ’Œ {w['text']}", show_alert=True)

    # Ø¨Ø¹Ø¯ Ø§Ù„ÙØªØ­ Ù†Ø­Ø°Ù Ø§Ù„Ù‡Ù…Ø³Ø© Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ†
    whispers.pop(wid, None)

def main():
    print("ğŸ¤– Whisper bot runningâ€¦")
    bot.infinity_polling()

if __name__=="__main__":
    main()
